name: Release Package

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout tag
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Validate tag format
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid tag format: $TAG"
            echo "Expected format: vX.Y.Z"
            exit 1
          fi

      - name: Prepare release package
        run: |
          set -euo pipefail

          TAG="${GITHUB_REF_NAME}"
          PKG_NAME="LM-Studio-Tray-Manager-${TAG}"
          STAGE_DIR="dist/${PKG_NAME}"

          rm -rf dist
          mkdir -p "$STAGE_DIR"

          FILES=(
            "lmstudio_autostart.sh"
            "lmstudio_tray.py"
            "setup.sh"
            "README.md"
            "LICENSE"
          )

          for file in "${FILES[@]}"; do
            if [[ -f "$file" ]]; then
              mkdir -p "$STAGE_DIR/$(dirname "$file")"
              cp -a "$file" "$STAGE_DIR/$file"
            fi
          done

          if [[ -f "docs/SETUP.md" ]]; then
            mkdir -p "$STAGE_DIR/docs"
            cp -a "docs/SETUP.md" "$STAGE_DIR/docs/SETUP.md"
          fi

          echo "$TAG" > "$STAGE_DIR/VERSION"

      - name: Create archives
        run: |
          set -euo pipefail

          TAG="${GITHUB_REF_NAME}"
          PKG_NAME="LM-Studio-Tray-Manager-${TAG}"

          tar -czf "dist/${PKG_NAME}.tar.gz" -C dist "$PKG_NAME"
          zip -rq "dist/${PKG_NAME}.zip" "dist/${PKG_NAME}"

          cp "dist/${PKG_NAME}.tar.gz" "dist/LM-Studio-Tray-Manager-latest.tar.gz"
          cp "dist/${PKG_NAME}.zip" "dist/LM-Studio-Tray-Manager-latest.zip"

      - name: Generate checksums
        run: |
          set -euo pipefail
          cd dist
          sha256sum *.tar.gz *.zip > SHA256SUMS.txt

      - name: Create GitHub release
        uses: softprops/action-gh-release@c062e08bd532815e2082a85e87e3ef29c3e6d191 # v2.0.8
        with:
          name: LM-Studio-Tray-Manager - ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            dist/*.tar.gz
            dist/*.zip
            dist/SHA256SUMS.txt
