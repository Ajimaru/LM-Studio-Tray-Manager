name: Release Package

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout tag
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Validate tag format
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid tag format: $TAG"
            echo "Expected format: vX.Y.Z"
            exit 1
          fi

      - name: Install binary build dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            bc \
            pkg-config \
            python3.10 \
            python3.10-venv \
            python3.10-dev \
            python3-gi \
            gobject-introspection \
            gir1.2-gtk-3.0 \
            gir1.2-ayatanaappindicator3-0.1 \
            libgirepository1.0-dev \
            upx-ucl

      - name: Build standalone binary
        run: |
          set -euo pipefail
          ./build.sh
          if [[ ! -f "dist/lmstudio-tray-manager" ]]; then
            echo "Binary missing after build"
            exit 1
          fi
          cp -a "dist/lmstudio-tray-manager" "/tmp/lmstudio-tray-manager"

      - name: Prepare release packages
        run: |
          set -euo pipefail

          TAG="${GITHUB_REF_NAME}"
          PKG_NAME_SRC="LM-Studio-Tray-Manager-${TAG}"
          PKG_NAME_BIN="LM-Studio-Tray-Manager-${TAG}-binary"
          STAGE_DIR_SRC="dist/${PKG_NAME_SRC}"
          STAGE_DIR_BIN="dist/${PKG_NAME_BIN}"

          rm -rf dist
          mkdir -p "$STAGE_DIR_SRC" "$STAGE_DIR_BIN"

          FILES=(
            "lmstudio_autostart.sh"
            "lmstudio_tray.py"
            "setup.sh"
            "README.md"
            "LICENSE"
            "AUTHORS"
            "VERSION"
          )

          for file in "${FILES[@]}"; do
            if [[ -f "$file" ]]; then
              mkdir -p "$STAGE_DIR_SRC/$(dirname "$file")"
              cp -a "$file" "$STAGE_DIR_SRC/$file"
            fi
          done

          if [[ -f "docs/SETUP.md" ]]; then
            mkdir -p "$STAGE_DIR_SRC/docs" "$STAGE_DIR_BIN/docs"
            cp -a "docs/SETUP.md" "$STAGE_DIR_SRC/docs/SETUP.md"
            cp -a "docs/SETUP.md" "$STAGE_DIR_BIN/docs/SETUP.md"
          fi

          if [[ -f "docs/BUILD.md" ]]; then
            mkdir -p "$STAGE_DIR_BIN/docs"
            cp -a "docs/BUILD.md" "$STAGE_DIR_BIN/docs/BUILD.md"
          fi

          BIN_FILES=()
          for file in "${FILES[@]}"; do
            if [[ "$file" != "lmstudio_tray.py" ]]; then
              BIN_FILES+=("$file")
            fi
          done

          for file in "${BIN_FILES[@]}"; do
            if [[ -f "$file" ]]; then
              mkdir -p "$STAGE_DIR_BIN/$(dirname "$file")"
              cp -a "$file" "$STAGE_DIR_BIN/$file"
            fi
          done

          if [[ ! -f "/tmp/lmstudio-tray-manager" ]]; then
            echo "Error: Binary not found at /tmp/lmstudio-tray-manager"
            exit 1
          fi
          cp -a "/tmp/lmstudio-tray-manager" \
            "$STAGE_DIR_BIN/lmstudio-tray-manager"

      - name: Create archives
        run: |
          set -euo pipefail

          TAG="${GITHUB_REF_NAME}"
          PKG_NAME_SRC="LM-Studio-Tray-Manager-${TAG}"
          PKG_NAME_BIN="LM-Studio-Tray-Manager-${TAG}-binary"

          tar -czf "dist/${PKG_NAME_SRC}.tar.gz" -C dist "$PKG_NAME_SRC"
          tar -czf "dist/${PKG_NAME_BIN}.tar.gz" -C dist "$PKG_NAME_BIN"


      - name: Generate checksums
        run: |
          set -euo pipefail
          cd dist
          sha256sum *.tar.gz > SHA256SUMS.txt

      - name: Create GitHub release
        uses: softprops/action-gh-release@c062e08bd532815e2082a85e87e3ef29c3e6d191 # v2.0.8
        with:
          name: ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            dist/*.tar.gz
            dist/SHA256SUMS.txt
